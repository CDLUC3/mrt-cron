# -------------------
# The Object Health process has 3 phases
# - BUILD: take information from the INV database and represent that information in Json.
#   - A sensible limitation will be placed on the number of files to analyze for an object (1000).
# - ANALYSIS: An analysis TASK will analyze the build information and create a new Json structure that may be queried by one or more tests.
# - TESTS: A TEST will perform a series of tests on an object.  A test will always return a status: SKIP, PASS, INFO, WARN, FAIL
#
# Generic Configuration Parameters that can be added to any TASK or TEST configuration
#   collection_scope:
#      skip:
#      - merritt_demo
#      - escholarship
#      apply:
#      - mnemonic

# -------------------
default:
  # -------------------
  # Runtime Options
  #   default command line parameters (see usage info for more information)
  # -------------------
  default-params: 
    QUERY: collection
    MNEMONIC: merritt_demo
    LIMIT: 10
  # debug settings to control debug messages and output
  debug:
    export_max: 5
    print_max: 1

  # -------------------
  # System Configuration
  # -------------------

  # open search connection parameters
  opensearch:
    host: "{!SSM: objhealth/opensearch_host}"
    user: "{!SSM: objhealth/opensearch_user}"
    password: "{!SSM: objhealth/opensearch_password}"
    transport_options:
      ssl: 
        verify: "{!SSM: objhealth/opensearch_ssl}"
  # database connection parameters
  dbconf:
    adapter: mysql2
    encoding: utf8mb4
    collation: utf8mb4_unicode_ci
    host: "{!SSM: billing/db-host}"
    database: "{!SSM: billing/db-name}"
    port: 3306
    username: "{!SSM: billing/readwrite/db-user}"
    password: "{!SSM: billing/readwrite/db-password}"

  # -------------------
  # Object Selection Queries
  # -------------------
  # Select objects to process
  # Note that this code presumes that OpenContext, ETD Reports, Dryad and Merritt admin collections will always be excluded
  gather-ids:
    select: |
      select o.id
      from inv.inv_objects o
      inner join inv.inv_collections_inv_objects icio on icio.inv_object_id = o.id
      inner join inv.inv_collections c on c.id = icio.inv_collection_id
      where 1=1
      and c.mnemonic not in ('cdl_dryad', 'ucb_open_context', 'cdl_uc3_etdreports') 
      and c.mnemonic not like '%_dash'
      and c.mnemonic not like 'mrt_%'
    # Default exclude sql fragment
    default-exclusion: |
      and 0 = 1
      limit {{LIMIT}}
    # Sql fragment to only pull objects that need to be re-built
    build-exclusion: |
      and not exists (
        select 1 from object_health_json h where h.inv_object_id = o.id and h.build_updated > o.modified
      )
      order by o.modified desc
      limit {{LIMIT}}
    # Sql fragment to only pull objects that need to be re-analyzed
    analysis-exclusion: |
      and exists(
        select 1 from object_health_json h where h.inv_object_id = o.id and h.build is not null
      )
      and not exists (
        select 1 from object_health_json h where h.inv_object_id = o.id and h.analysis_updated >= h.build_updated
      )
      order by o.modified desc
      limit {{LIMIT}}
    # Sql fragment to only pull objects that need to be re-tested
    tests-exclusion: |
      and exists(
        select 1 from object_health_json h where h.inv_object_id = o.id and h.analysis is not null
      )
      and not exists (
        select 1 from object_health_json h where h.inv_object_id = o.id and h.tests_updated >= h.analysis_updated
      )
      order by o.modified desc
      limit {{LIMIT}}
    # prioritized set of queries to use to find work to be performed.  If one query returns no results, the next one will be run
    queries:
      # query by collection mnemonic
      collection: |
        and c.mnemonic = '{{MNEMONIC}}'
      # query for objects with an existing build representation
      has-build: |
        and exists (select 1 from object_health_json h where h.inv_object_id = o.id)

  # -------------------
  # Collection Taxonomy
  #   This can be used to include/exclude specific collections from specific Analysis Tasks and Tests
  # -------------------
  collection_taxonomy:
    colltax_skip:
      patterns: 
      - ^.*_dash$
      - ^mrt_.*$
      mnemonics:
      - ucb_open_context
      - cdl_dryad
      - cdl_uc3_etdreports
      #rhodecode
    colltax_lsta:
      patterns:
      - ^lsta_.*$
    colltax_nuxeo:
      #mnemonics: 
      #- ...
    # tind
    # expanded bags (UCI, UCSC)
    # etds
    colltax_cdl:
      mnemonics:
      - merritt_demo
      - escholarship

  # -------------------
  # Statistical Analysis Queries
  #   This is not yet in the project scope
  # -------------------
  analysis-inputs:
    duplicate-checksum:
      note: consider excluding opencontext
      query: |
        select source, digest_value, full_size, count(*) 
        from inv_files 
        where source='producer' and full_size=billable_size 
        group by source, digest_value, full_size 
        having count(*) > 1 order by count(*);
    average-object-size-for-collection:
      description: compute average, mean file size to identify outliers
    average-file-size-for-collection-and-mime:
      description: compute average, mean file size to identify outliers
    average-file-size-for-mime-type:
      description: compute average, mean file size to identify outliers
    duplicate-title-in-collection:

  # -------------------
  # Object Analysis Tasks
  # -------------------
  analysis-json:
    # -------------------
    # Organize known Merritt mime types by sustainability criteria.
    # Organization of mime types will be updated over time to incorporate community best practices.
    # Also, document the expected file extensions for each sustainable mime type.
    # 
    # The PASS and INFO mime types will be utilized to identify digital file content within an object.
    # Each object will be expected to contain at least one file from each of these groups.
    #
    # Apache Tika has been used within Merritt to identify mime types (TBD verify).  
    # Also, this information can be sent by depositors.
    # The results of this analysis may suggest that Merritt should process all content files with file identification software.
    # -------------------
    mime:
      class: MimeTask
      PASS: &sustainable_mimes_pass
        text/plain: ["txt"]
        application/xml: ["xml"]
        image/jpeg: ["jpg", "jpeg"]
        image/tiff: ["tif", "tiff"]
        application/xhtml+xml: ["xhtml"]
        application/pdf: ["pdf"]
        application/atom+xml: ["xml"]
        image/gif: ["gif"]
        text/csv: ["csv"]
        application/x-gzip: ["gzip", "gz"]
        text/html: ["html", "htm"]
        image/png: ["png"]
        application/vnd.openxmlformats-officedocument.wordprocessingml.document: ["docx"]
        application/zip: ["zip"]
        application/msword: ["doc"]
        audio/x-wav: ["wav"]
        audio/mpeg: ["mpeg"]
        application/vnd.openxmlformats-officedocument.spreadsheetml.sheet: ["xlsx"]
        application/json: ["json"]
        application/mxf: ["mxf"]
        application/gzip: ["gzip", "gz"]
        application/vnd.ms-excel: ["xls"]
        video/mp4: ["mp4"]
        video/quicktime: []
        application/vnd.openxmlformats-officedocument.presentationml.presentation: ["pptx"]
        application/vnd.ms-powerpoint: ["ppt"]
      # Leave SKIP blank to help identify unfound mimes
      SKIP:
      FAIL:
      # x-pkcs: Public-Key Cryptography Standards files provide for certificate storage
        application/x-pkcs12: []
        application/x-pkcs7-certificates: []
      # binary.macroenabled.12: Binary Excel spreadsheet with macros enabled
        application/vnd.ms-excel.sheet.binary.macroenabled.12: []
      # appledouble: Apple dual-forked file typically excluded from containers
        multipart/appledouble: []
      WARN: &sustainable_mimes_warn
        application/octet-stream: []
        application/vnd.chipnuts.karaoke-mmd: []
        application/vnd.ms-excel.sheet.macroenabled.12: []
        application/vnd.ms-powerpoint.presentation.macroenabled.12: []
        application/vnd.ms-word.document.macroenabled.12: []
        application/x-stata-dta: []
        application/x-stata-dta; version=13: []
        application/x-stata-dta; version=14: []
        text/x-stsrc: []
      INFO: &sustainable_mimes_info
        application/x-hdf: []
        application/x-matlab-data: []
        text/x-rsrc: []
        application/x-gtar: ["gz"]
        application/rtf: []
        audio/x-aiff: []
        application/postscript: []
        text/x-actionscript: []
        image/vnd.adobe.photoshop: []
        audio/vnd.wave: []
        application/x-tika-msoffice: ["db"]
        application/x-rar-compressed: []
        application/x-netcdf: []
        video/x-msvideo: []
        model/vnd.mts: []
        text/tab-separated-values: ["tsv"]
        image/x-raw-panasonic: []
        text/x-matlab: []
        application/x-dbf: []
        application/x-7z-compressed: []
        application/x-shapefile: []
        text/x-vcard: []
        video/x-matroska: []
        application/x-tar: []
        image/svg+xml: []
        image/x-raw-canon: []
        video/mpeg: []
        application/xv+xml: []
        video/x-ms-wmv: []
        audio/x-ms-wma: []
        application/x-shockwave-flash: []
        text/x-python: []
        video/x-m4v: []
        application/x-sh: []
        application/x-dosexec: []
        application/java-vm: []
        image/x-ms-bmp: []
        text/x-objcsrc: []
        application/x-webarchive: []
        application/x-bzip2: []
        message/rfc822: []
        application/vnd.ms-pki.stl: []
        text/x-ruby: []
        application/x-tika-ooxml: []
        text/x-log: []
        text/x-perl: []
        application/marc: []
        text/x-web-markdown: ["md"]
        application/dicom: []
        application/vnd.oasis.opendocument.spreadsheet: []
        application/x-adobe-indesign: []
        video/x-flv: []
        audio/mp4: []
        application/vnd.quark.quarkxpress: []
        application/vnd.syncml.dm+wbxml: []
        text/x-php: []
        application/vnd.ms-excel.sheet.4: []
        application/x-sqlite3: []
        application/x-iso9660-image: []
        image/bmp: []
        application/javascript: []
        application/vnd.oasis.opendocument.text: []
        text/x-csrc: []
        application/vnd.ms-outlook: []
        text/x-c++src: []
        application/vnd.google-earth.kmz: []
        text/css: []
        application/x-elc: []
        application/x-tex: []
        text/troff: []
        text/x-java-source: []
        application/x-font-ttf: []
        application/java-archive: []
        application/x-font-otf: []
        image/x-pict: []
        application/x-123: []
        image/vnd.radiance: []
        chemical/x-cif: []
        application/vnd.ms-works: []
        application/mathematica: []
        application/vnd.wordperfect: []
        application/x-sas: []
        application/x-bplist: []
        application/zlib: []
        application/x-xz: []
        video/3gpp: []
        application/illustrator: []
        text/x-fortran: []
        audio/vorbis: []
        application/vnd.wordperfect; version=6.x: []
        application/vnd.google-earth.kml+xml: []
        audio/basic: []
        text/x-chdr: []
        application/x-msdownload; format=pe32: []
        application/x-font-bdf: []
        application/vnd.apple.pages: []
        application/vnd.oasis.opendocument.base: []
        video/x-ms-asf: []
        text/x-sql: []
        application/x-stuffit: []
        application/vnd.apple.numbers: []
        application/vnd.rn-realmedia: []
        application/x-msaccess: []
        application/rss+xml: []
        text/sgml: []
        application/x-erdas-hfa: []
        text/x-coldfusion: []
        application/vnd.adobe.xfl: []
        image/x-portable-bitmap: []
        application/x-sas-audit: []
        text/x-pascal: []
        application/x-bzip: []
        application/vnd.iccprofile: []
        application/x-bat: []
        text/x-rst: []
        image/vnd.dxf; format=ascii: []
        application/x-sas-data: []
        application/epub+zip: []
        image/vnd.zbrush.pcx: []
        text/x-d: []
        image/x-portable-graymap: []
        application/vnd.mcd: []
        image/x-xcf: []
        audio/midi: []
        application/x-mspublisher: []
        image/vnd.microsoft.icon: []
        application/x-bibtex-text-file: []
        application/x-compress: []
        application/x-mobipocket-ebook: []
        application/vnd.visio: []
        application/vnd.ms-xpsdocument: []
        application/smil+xml: []
        text/x-prolog: []
        application/vnd.ms-spreadsheetml: []
        message/news: []
        application/vnd.apple.keynote: []
        application/vnd.adobe.air-application-installer-package+zip: []
        text/x-ml: []
        application/vnd.adobe.indesign-idml-package: []
        application/x-sharedlib: []
        application/fits: []
        text/vnd.graphviz: []
        text/x-asciidoc: []
        application/sereal; version=3: []
        text/x-assembly: []
        text/x-basic: []
        text/x-yaml: []
        application/msword2: []
        application/vnd.ms-tnef: []
        image/x-portable-pixmap: []
        application/vnd.ms-word2006ml: []
        text/x-vbasic: []
        application/x-ms-owner: []
        text/x-ini: []
        application/vnd.yamaha.smaf-phrase: []
        application/vnd.ms-excel.sheet.3: []
        image/x-icon: []
        text/x-diff: []
        application/vnd.lotus-freelance: []
        application/x-dtbresource+xml: []
        application/x-msdownload: []
        application/x-msdownload; format=pe64: []
        text/x-tcl: []
        message/x-emlx: []
        application/msword5: []
        text/x-common-lisp: []
        text/x-aspectj: []
        application/vnd.oasis.opendocument.chart: []
        application/x-executable: []
        application/vnd.oasis.opendocument.presentation: []
        text/x-modula: []
        image/wmf: []
        text/calendar: []
        application/vnd.openxmlformats-officedocument.presentationml.template: []
        application/x-xfig: []
        chemical/x-cdx: []
        application/vnd.openxmlformats-officedocument.spreadsheetml.template: []
        text/prs.lines.tag: []
        application/pgp-signature: []
        text/x-groovy: []
        application/vnd.tcpdump.pcap: []
        text/x-haml: []
        application/vnd.mif: []
        application/x-emf: []
        application/vnd.ms-cab-compressed: []
        image/vnd.dwg: []
        application/vnd.adobe.fxp: []
        application/x-font-linux-psf: []
        application/mbox: []
        text/x-c++hdr: []
        # note - moved these from SKIP to INFO
        plain/turtle: ["ttl"]
        application/rdf+xml: []

    # -------------------
    # Classify Object Producer Files based on an ordered set of rules
    #
    # Content Classifications
    # - complex_object - container file found or preservation files of multiple mime types found within the object
    # - has_multi_digital_files_with_derivatives - multiple preservation files of the same mime type found and derivative files found
    # - has_multi_digital_files - multiple preservation files of the same mime type found
    # - has_digital_file_with_derivatives - preservation and derivative files found
    # - has_derivatives_only - only derivative content files found
    # - has_single_digital_file - one identifiable content file
    # - has_no_content - no identifiable content files
    #
    # Metadata Classifications
    # - has_common_metadata_file: "Common" Merritt metadata file 
    # - has_bag_metadata_file: Bag metadata file derived from a bagged object
    # - has_etd_metadata_file: Metadata sidecar file for an ETD submission
    # - has_nuxeo_style_metadata_file: Metadata sidecar file for a Nuxeo submission
    # - has_metadata_with_secondary: Primary metadata sidecar file plus other metadata files
    # - has_single_metadata_file: Primary metadata sidecar file
    # - has_multi_metadata: Multiple potential metadata sidecar files
    # - has_secondary_metadata_only: Files containing metadata that would not be classified as a sidecar file. A sidecar is assumed to have richer metadata than a Merritt ERC file.
    # - has_no_sidecar_metadata: No identifiable metadat file found
    # -------------------
    classify:
      class: ClassifyTask
      # These categorizations are applied in ranked order allowing the re-use of blocks of mime types
      metadata_types:
        common_metadata:
        nuxeo_style_metadata:
        bag_metadata:
        etd_metadata:
        metadata:
      categorize:
      # If multiple common metadata files are found, the primary metadata file will be chosen in the following priority order
      - name: common_metadata
        # this indicates that the first match will be used regardless of the number of matches
        ordered_paths: true
        paths:
        - mets.xml
        - mets.txt
        - mrt-dc.xml
        - cdlmeta.tar.gz
      # If ETD metadata is found, other metadata files will not affect the categorization
      - name: etd_metadata
        patterns:
        - ^.*_(ucr|ucla)_.*_DATA.xml$
      # If Nuxeo metadata is found, other metadata files will not affect the categorization.
      # Allowable template values to look for:
      # - ARK
      - name: nuxeo_style_metadata
        templates:
        - "{{ARK}}.xml"
      # If bag metadata is found, other metadata files will not affect the categorization.
      - name: bag_metadata
        paths:
        - bag-info.txt
      # If mutliple metadata files are found the categorization will indicate that the primary file cannot be identified.
      - name: metadata
        mimes:
          application/xml:
          application/json:
      # Secondary metadata files may contain metadata, but they are not considered to be a good choice as a "primary" metadata file
      - name: secondary
        mimes:
          text/plain:
          application/xhtml+xml:
          application/atom+xml:
          text/html:
        paths:
        - mrt-erc.txt
      # Complex files may contain multiple types of digital files.  The object will need to be downloaded and expanded in order to introspect the object.
      - name: complex
        mimes:
          application/x-gzip:
          application/zip:
          application/gzip:
      # Common derivative file types.  These file types are not generally good choices for preservation on their own.  These files will generally accompany primary content files.
      - name: derivatives
        mimes:
          video/mp4:
          audio/mpeg3:
          image/jpeg:
          image/gif:
      # Common digitial files types for preservation
      # Note that this section is linking out to the sustainable mime type definitions elsewhere in the yaml file.
      # Any metadata or derivative file types should be categorized in the sections above.
      - name: content
        mimes:
          <<: *sustainable_mimes_pass
          <<: *sustainable_mimes_info
      # everything else is classified as :na

  # -------------------
  # Bitstream Analysis: these functions are not yet in scope for Merritt
  # -------------------
  #analysis-bitstream:
  #  format-id:
  #  virus-scan:
  #  pii-scan:
  #  accessibility-scan:

  # -------------------
  # Object Health Tests
  #   These tests will be performed using the data contained within the build and analysis json for an object.  No external resources should be needed.
  #   All tests will return one of the following stats
  #   - SKIP: test was skipped
  #   - PASS: test passed, object is configured as expected
  #   - INFO: some irregularity was found, intervention is not expected
  #   - WARN: some irregularity was found, intervention is recommended
  #   - FAIL: significant irregularity was found, action should be taken to resolve the issue
  # -------------------
  tests:
    # Evaluate the sustainability of fhe mime types for producer files within the object
    sustainable-mime:
      class: MimeTest
      name: Mime type sustainability
      description: Compare file extention (or known mime type) to a list of sustainable mime types.
    # Evaluate whether or not the file extension for a producer file is expected for a given mime type
    mime-extension-mismatch:
      class: MimeExtTest
    mime-not-found:
      class: MimeNotFoundTest
    # Evaluate the object classification based on producer file types
    object-classification:
      class: ObjectClassificationTest
      status_keys:
        PASS:
          has_multi_digital_files:
          has_multi_digital_files_with_derivatives:
          has_digital_file_with_derivatives:
          has_single_digital_file:
        INFO:
          complex_object:
        WARN:
          derviatives_only:
        FAIL:
          has_no_content:
    # Evaluate the object metadata classification based on producer file types
    metadata-classification:
      class: MetadataClassificationTest
      status_keys:
        PASS:
          has_common_metadata_file:
          has_bag_metadata_file:
          has_etd_metadata_file:
          has_metadata_with_secondary:
          has_nuxeo_style_metadata_file:
          has_single_metadata_file:
        INFO:
          has_multi_metadata:
        WARN:
          has_secondary_metadata_only:
          has_no_sidecar_metadata:
        FAIL:
    # Test for URL-like Merritt pathnames that may not expand well into a filename
    ext-url-like-pathname:
      class: ExtUrlTest
    # Test for Merritt pathnames that may not expand well into a filename
    ext-not-present:
      class: ExtNotPresentTest
    # Test for zero byte content files
    empty-file:
      name: Empty file detection
      description: Check file size - WARN if empty producer, INFO if empty system
      class: EmptyTest
    # Test for Merritt objects in which a delete was performed between object versions.
    has-delete:
      description: INFO if delete detected
      class: DeletedTest
    # Test Merritt ERC for missing or indistinct data
    doesnt-have-meaningful-erc-what:
      name: Object has meaningful ERC metadata
      description: at first look for empty fields
      class: ErcWhatTest
      status_matcher:
        FAIL:
          patterns:
          - "^$"
        WARN:
          values:
          - "(:unas)"
        INFO:
          values:
          - "(title unknown)"
          - "[Untitled]"
          - "Untitled"
    # Test Merritt ERC for missing or indistinct data
    doesnt-have-meaningful-erc-who:
      name: Object has meaningful ERC metadata
      description: at first look for empty fields
      class: ErcWhoTest
      status_matcher:
        FAIL:
          patterns:
          - "^$"
        WARN:
          values:
          - "(:unav)"
          - "(:unas)"
    # Test Merritt ERC for missing or indistinct data
    doesnt-have-meaningful-erc-when:
      name: Object has meaningful ERC metadata
      description: at first look for empty fields
      class: ErcWhenTest
      status_matcher:
        FAIL:
          patterns:
          - "^$"
        WARN:
          values:
          - "(:unav)"
          - "(:unas)"
        INFO:
          values:
          - "[Date not indicated]"
          - "n.d."
          - "undated"
    # Test for the presence of a Merritt Embargo
    has-embargo:
      name: "Has embargo / had embargo"
      class: EmbargoTest
    # Find objects without a localid
    # Note: some Merritt collections never set a localid.  Those collections should be SKIP
    no-local-id:
      name: Object has local id
      class: LocalIdTest
      # all tasks and tests can be scoped to run/not run for specific collections
      collection_scope:
        skip:
        #- merritt_demo
        #- escholarship
        - colltax_cdl
        - lsta_pomonapl
        # apply:
        # - mnemonic
    # -------------------------
    # Future Tests to define and implement
    # -------------------------
    #has-duplicate-checksum:
    #has-duplicate-object-title:
    #filename-valid:
    #  name: Filename validation
    #  description: Rule varies by collection. Some default pattern matches for meaningless file names
    #unusual-file-size:
    #  name: Unusual file size
    #  description: Compare file size to expectations for an extension type.  Re-compute based on the corpus. Determine some standard deviation rule to flag items.
    #has-sidecar-metadata:
    #  name: Object has sidecar metadata
    #localid-invalid:
    #  name: Local id conforms to naming standards for collection
    #erc-invalid:
    #  name: ERC metadata conforms to naming standards for collection
    #filesize-invalid:
    #  name: File size is within typical size range for the collection
